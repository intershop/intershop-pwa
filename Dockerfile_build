FROM node:8-alpine
RUN node --version
RUN npm --version
COPY package.json package-lock.json /workspace/
COPY tslint-rules /workspace/tslint-rules/
WORKDIR /workspace/tslint-rules/
RUN set -x \
&&  before=$(find dist package-lock.json -type f -exec md5sum {} \; | sort | md5sum | awk '{ print $1 }') \
&&  npm run build \
&&  after=$(find dist package-lock.json -type f -exec md5sum {} \; | sort | md5sum | awk '{ print $1 }') \
&&  test "$before" = "$after"
WORKDIR /workspace/
RUN set -x \
&&  before=$(md5sum package-lock.json | awk '{ print $1 }') \
&&  npm install \
&&  after=$(md5sum package-lock.json | awk '{ print $1 }') \
&&  test "$before" = "$after"
COPY . /workspace/
RUN npm run test --silent -- --ci --testPathIgnorePatterns '.*.(component|container).spec.ts'
RUN npm run test --silent -- --ci '.*.component.spec.ts'
RUN npm run test --silent -- --ci '.*.container.spec.ts'
RUN npm run lint
RUN npm run build:dynamic:prod
RUN set -x \
&&  before=$(find src e2e tslint-rules/src *.json *.ts -type f -exec md5sum {} \; | sort | md5sum | awk '{ print $1 }') \
&&  npm run format \
&&  after=$(find src e2e tslint-rules/src *.json *.ts -type f -exec md5sum {} \; | sort | md5sum | awk '{ print $1 }') \
&&  test "$before" = "$after"
RUN npx tsc -p src/tsconfig.spec.json
